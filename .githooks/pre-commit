#!/bin/sh
#
# Pre-commit Hook - Check for Hardcoded Values
# ==============================================
# This hook prevents commits that contain hardcoded values.
#
# To install:
#   chmod +x .githooks/pre-commit
#   git config core.hooksPath .githooks
#
# To bypass (use sparingly!):
#   git commit --no-verify
#

echo "üîç Checking for hardcoded values..."

# Colors
RED='\033[0;31m'
YELLOW='\033[1;33m'
GREEN='\033[0;32m'
NC='\033[0m' # No Color

# Track if we found any issues
FOUND_ISSUES=0

# Get list of staged files
STAGED_FILES=$(git diff --cached --name-only --diff-filter=ACM)

if [ -z "$STAGED_FILES" ]; then
    echo "${GREEN}‚úÖ No files to check${NC}"
    exit 0
fi

echo "Checking $(echo "$STAGED_FILES" | wc -l) files..."

# Check for hardcoded localhost URLs
echo "\nüì° Checking for hardcoded URLs..."
HARDCODED_URLS=$(echo "$STAGED_FILES" | xargs grep -nE "http://(localhost|127\.0\.0\.1):[0-9]+" 2>/dev/null | grep -v "config\.js\|test_config\.py\|\.md\|\.example\|comment\|documentation" || true)

if [ ! -z "$HARDCODED_URLS" ]; then
    echo "${RED}‚ùå Found hardcoded URLs:${NC}"
    echo "$HARDCODED_URLS"
    echo "\n${YELLOW}üí° Use API_CONFIG.BASE_URL (frontend) or test_config (backend)${NC}"
    FOUND_ISSUES=1
fi

# Check for hardcoded passwords
echo "\nüîê Checking for hardcoded passwords..."
HARDCODED_PASSWORDS=$(echo "$STAGED_FILES" | xargs grep -nE "password\s*=\s*['\"](?!.*test_config|.*get_test_password|.*row|.*data\[|.*request|.*form|.*user\.)(admin123|pass123|mentor123|floorwing123|testpass123|test123)" 2>/dev/null | grep -v "\.md\|\.example\|comment" || true)

if [ ! -z "$HARDCODED_PASSWORDS" ]; then
    echo "${RED}‚ùå Found hardcoded passwords:${NC}"
    echo "$HARDCODED_PASSWORDS"
    echo "\n${YELLOW}üí° Use get_test_password() from test_config.py${NC}"
    FOUND_ISSUES=1
fi

# Check for hardcoded database credentials
echo "\nüóÑÔ∏è  Checking for hardcoded database credentials..."
HARDCODED_DB=$(echo "$STAGED_FILES" | xargs grep -nE "(postgresql|mysql|mongodb)://[^@]+:[^@]+@" 2>/dev/null | grep -v "\.md\|\.example\|comment\|DATABASE_URL" || true)

if [ ! -z "$HARDCODED_DB" ]; then
    echo "${RED}‚ùå Found hardcoded database credentials:${NC}"
    echo "$HARDCODED_DB"
    echo "\n${YELLOW}üí° Use DATABASE_URL environment variable${NC}"
    FOUND_ISSUES=1
fi

# Check for SECRET_KEY or JWT_SECRET_KEY in non-example files
echo "\nüîë Checking for exposed secret keys..."
EXPOSED_SECRETS=$(echo "$STAGED_FILES" | grep -v ".example" | xargs grep -nE "(SECRET_KEY|JWT_SECRET_KEY)\s*=\s*['\"][^'\"]{20,}" 2>/dev/null | grep -v "os\.getenv\|settings\.py" || true)

if [ ! -z "$EXPOSED_SECRETS" ]; then
    echo "${RED}‚ùå Found exposed secret keys:${NC}"
    echo "$EXPOSED_SECRETS"
    echo "\n${YELLOW}üí° Use environment variables for secret keys${NC}"
    FOUND_ISSUES=1
fi

# Check for actual .env files being committed
echo "\nüìÑ Checking for .env files..."
ENV_FILES=$(echo "$STAGED_FILES" | grep -E "\.env$|\.env\.local$" || true)

if [ ! -z "$ENV_FILES" ]; then
    echo "${RED}‚ùå Attempting to commit .env files:${NC}"
    echo "$ENV_FILES"
    echo "\n${YELLOW}üí° Never commit .env files! Use .env.example instead${NC}"
    FOUND_ISSUES=1
fi

# Summary
echo "\n" "=" | tr -d '\n'; printf '%.0s=' {1..60}; echo
if [ $FOUND_ISSUES -eq 1 ]; then
    echo "${RED}‚ùå COMMIT BLOCKED - Hardcoded values detected${NC}"
    echo "\nPlease fix the issues above or use --no-verify to bypass (not recommended)."
    echo "\nReferences:"
    echo "  - Frontend: src/config/index.js"
    echo "  - Backend:  backend/test_config.py"
    echo "  - Guide:    CONFIG_QUICK_REFERENCE.md"
    echo
    exit 1
else
    echo "${GREEN}‚úÖ No hardcoded values detected - commit allowed${NC}"
    echo
    exit 0
fi
